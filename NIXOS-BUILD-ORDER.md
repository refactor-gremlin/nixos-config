# âœ… NixOS Build Checklist â€” Ordered by Execution

**Machine:** ASUS ROG Strix G16 (G614, 2024) â€“ RTX 4080
**User:** jens
**Desktop:** KDE Plasma 6 (Wayland)
**Use case:** Gaming + Programming

---

## ğŸ”´ PHASE 0 â€” Before Installation (Hard Requirements)

These must be decided **before** you run the installer.

### Firmware & Boot

* [ ] UEFI mode enabled in BIOS
* [ ] Secure Boot **disabled**
* [ ] systemd-boot chosen as bootloader
* [ ] EFI partition size decided (~1 GB)

### Disk Layout Decisions

* [ ] NixOS only (no dual boot)
* [ ] LUKS2 full-disk encryption
* [ ] Btrfs chosen as filesystem
* [ ] Swap size decided: **40 GB**
* [ ] Hibernation planned (resume from swap)

---

## ğŸ”´ PHASE 1 â€” Disk, Encryption & Filesystem (Installer Stage)

Do **not** continue until this is correct.

### Disk & Encryption

* [ ] LUKS2 full-disk encryption applied
* [ ] Swap partition / LV created (40 GB)
* [ ] Resume from swap enabled

### Btrfs Layout

* [ ] Root filesystem is Btrfs
* [ ] Subvolumes created:

  * [ ] /
  * [ ] /home
  * [ ] /nix
  * [ ] (optional) /persist

---

## ğŸ”´ PHASE 2 â€” Base System & Flake Setup (First Boot)

This is your **foundation**.

### Localization & Hardware Plumbing

* [ ] Timezone: `time.timeZone = "Europe/Amsterdam"`
* [ ] Keyboard Layouts:
  * [ ] Primary: `services.xserver.xkb.layout = "us"`
  * [ ] Variant: `services.xserver.xkb.variant = "intl"`
  * [ ] Alternative: `services.xserver.xkb.options = "grp:alt_shift_toggle"` + add `"us,nl"` to layout
* [ ] Console keymap: `console.keyMap = "us"` (or `"us-intl"` if available)
* [ ] Locale: `i18n.defaultLocale = "en_GB.UTF-8"`
* [ ] Extra locale settings (optional):
  * [ ] `i18n.extraLocaleSettings.LC_TIME = "nl_NL.UTF-8"`
  * [ ] `i18n.extraLocaleSettings.LC_MONETARY = "nl_NL.UTF-8"`
* [ ] Firmware: `hardware.enableRedistributableFirmware = true`

### Connectivity

* [ ] NetworkManager: `networking.networkmanager.enable = true`
* [ ] Bluetooth: `hardware.bluetooth.enable = true`
* [ ] Bluetooth power on boot: `hardware.bluetooth.powerOnBoot = true`

### Base / Repo

* [ ] Use flakes
* [ ] Use nix-starter-configs (standard template)
* [ ] Directory structure (Option C â€” Subdirectory Modules):

```
nixos-config/
â”œâ”€â”€ flake.nix                         # Main entry point
â”œâ”€â”€ flake.lock
â”‚
â”œâ”€â”€ nixos/
â”‚   â”œâ”€â”€ configuration.nix             # Orchestrator (imports all subdirs)
â”‚   â”œâ”€â”€ hardware-configuration.nix    # Auto-generated by installer
â”‚   â”‚
â”‚   â”œâ”€â”€ system/                       # Phase 2-3: Core system
â”‚   â”‚   â”œâ”€â”€ default.nix               # Imports boot.nix, disk.nix, locale.nix
â”‚   â”‚   â”œâ”€â”€ boot.nix                  # systemd-boot, kernel, kernel params
â”‚   â”‚   â”œâ”€â”€ disk.nix                  # Btrfs, LUKS, swap, resume
â”‚   â”‚   â””â”€â”€ locale.nix                # Timezone, keyboard, i18n
â”‚   â”‚
â”‚   â”œâ”€â”€ hardware/                     # Phase 3-4: Hardware enablement
â”‚   â”‚   â”œâ”€â”€ default.nix               # Imports nvidia.nix, asus.nix, audio.nix
â”‚   â”‚   â”œâ”€â”€ nvidia.nix                # NVIDIA drivers, PRIME, modesetting
â”‚   â”‚   â”œâ”€â”€ asus.nix                  # asusd, supergfxd, ROG-specific
â”‚   â”‚   â””â”€â”€ audio.nix                 # Pipewire, ALSA, JACK, rtkit
â”‚   â”‚
â”‚   â”œâ”€â”€ desktop/                      # Phase 5, 7-8: Desktop & integration
â”‚   â”‚   â”œâ”€â”€ default.nix               # Imports plasma.nix, portals.nix
â”‚   â”‚   â”œâ”€â”€ plasma.nix                # KDE Plasma 6, SDDM, Wayland
â”‚   â”‚   â””â”€â”€ portals.nix               # XDG portals, MIME handlers, secrets
â”‚   â”‚
â”‚   â”œâ”€â”€ programs/                     # Phase 9-10: Applications
â”‚   â”‚   â”œâ”€â”€ default.nix               # Imports gaming.nix, development.nix
â”‚   â”‚   â”œâ”€â”€ gaming.nix                # Steam, Proton, GameMode, MangoHud
â”‚   â”‚   â””â”€â”€ development.nix           # Cursor, Docker, languages, direnv
â”‚   â”‚
â”‚   â””â”€â”€ services/                     # Phase 6, 11: Background services
â”‚       â”œâ”€â”€ default.nix               # Imports maintenance.nix, power.nix
â”‚       â”œâ”€â”€ maintenance.nix           # Snapper, GC, fwupd, Btrfs scrub
â”‚       â””â”€â”€ power.nix                 # Suspend, hibernate, lid actions
â”‚
â”œâ”€â”€ home-manager/
â”‚   â”œâ”€â”€ home.nix                      # User config orchestrator
â”‚   â”œâ”€â”€ shell.nix                     # Zsh, Oh-My-Zsh, Starship
â”‚   â””â”€â”€ programs.nix                  # User-level app configs
â”‚
â”œâ”€â”€ modules/                          # Reusable NixOS/HM modules
â”‚   â”œâ”€â”€ nixos/
â”‚   â”‚   â””â”€â”€ default.nix
â”‚   â””â”€â”€ home-manager/
â”‚       â””â”€â”€ default.nix
â”‚
â”œâ”€â”€ overlays/                         # Package modifications
â”‚   â””â”€â”€ default.nix
â”‚
â””â”€â”€ pkgs/                             # Custom packages
    â””â”€â”€ default.nix
```

* [ ] Module mapping by phase:

| Phase | Directory | Files |
|-------|-----------|-------|
| 2-3 | `system/` | `boot.nix`, `disk.nix`, `locale.nix` |
| 3-4 | `hardware/` | `nvidia.nix`, `asus.nix`, `audio.nix` |
| 5, 7-8 | `desktop/` | `plasma.nix`, `portals.nix` |
| 9-10 | `programs/` | `gaming.nix`, `development.nix` |
| 6, 11 | `services/` | `maintenance.nix`, `power.nix` |

### Bootloader
* [ ] systemd-boot configured
* [ ] Boot entries verified
* [ ] System boots without installer media

---

## ğŸŸ  PHASE 3 â€” Kernel & Hardware Enablement

Do this **before graphics and desktop**.

### Kernel

> **Note:** The 2024 ROG laptops have known speaker/WiFi issues on older kernels.
> Kernel 6.10+ is [recommended by asus-linux.org](https://asus-linux.org/guides/nixos/),
> and 6.12+ has better audio codec support for the G614 speakers.

* [ ] CachyOS kernel selected (or `linuxPackages_latest`)
* [ ] Kernel â‰¥ **6.12** (Better support for 2024 speakers/wifi)
* [ ] CachyOS binary cache enabled (avoids compiling from source)
* [ ] Kernel params:
  * [ ] `nvidia-drm.modeset=1` (required for Wayland)
  * [ ] `nvidia-drm.fbdev=1` (smoother console/boot)
  * [ ] (Optional) `acpi_backlight=native` (if brightness fails)

### Audio (Pipewire)

* [ ] Disable PulseAudio: `hardware.pulseaudio.enable = false`
* [ ] Enable Pipewire: `services.pipewire.enable = true`
* [ ] ALSA support: `services.pipewire.alsa.enable = true`
* [ ] 32-bit ALSA: `services.pipewire.alsa.support32Bit = true`
* [ ] PulseAudio compat: `services.pipewire.pulse.enable = true`
* [ ] JACK support: `services.pipewire.jack.enable = true`
* [ ] Low-latency config (optional):
  * [ ] `services.pipewire.extraConfig.pipewire."92-low-latency"` for gaming
* [ ] Enable real-time priority: `security.rtkit.enable = true`

---

## ğŸŸ  PHASE 4 â€” GPU, NVIDIA & ASUS Stack

Critical for stability on this laptop.

### NVIDIA

* [ ] Proprietary NVIDIA driver
* [ ] Modesetting enabled (Wayland requirement)
* [ ] NVIDIA power management enabled
* [ ] NVIDIA Settings available
* [ ] PRIME offload configured
* [ ] 32-bit graphics enabled

### ASUS / ROG Controls

> See [asus-linux.org/guides/nixos](https://asus-linux.org/guides/nixos/) for official NixOS guide.

* [ ] Supergfxd: `services.supergfxd.enable = true`
* [ ] Supergfxd fix: `systemd.services.supergfxd.path = [ pkgs.pciutils ]`
* [ ] Asusd: `services.asusd.enable = true`
* [ ] User services: `services.asusd.enableUserService = true`
* [ ] ROG Control Center GUI (included with asusd)
* [ ] `supergfxctl-plasmoid` (KDE tray widget)

---

## ğŸŸ  PHASE 5 â€” Desktop Environment

Only now bring up the UI.

### KDE Plasma

* [ ] KDE Plasma 6 installed
* [ ] Wayland session default
* [ ] SDDM display manager enabled
* [ ] X11 available as fallback (optional)

---

## ğŸŸ  PHASE 6 â€” Snapshots & Maintenance

Once the system boots cleanly.

### Snapshots

* [ ] Snapper enabled for `/`
* [ ] Automatic timeline snapshots
* [ ] Automatic cleanup
* [ ] Weekly Btrfs scrub

> From this point on, you have rollback safety.

---

## ğŸŸ¡ PHASE 7 â€” User, Shell & Session Defaults

Quality-of-life basics.

### User

* [ ] User: **jens**
* [ ] Zsh as default shell
* [ ] (Optional) Oh-My-Zsh

---

## ğŸŸ¡ PHASE 8 â€” Cross-App Integration & Wayland Glue

This prevents **â€œwhy doesnâ€™t this openâ€** problems later.

### Core Plumbing

* [ ] XDG Portal enabled
* [ ] KDE portal used
* [ ] `xdg-open` available system-wide

### Default Handlers

* [ ] Default browser set (Chrome)
* [ ] Default file manager (Dolphin)
* [ ] Default PDF viewer
* [ ] Default text editor (Cursor / Code)

### URL & Protocols (only what you use)

* [ ] `http://` / `https://`
* [ ] `mailto:`
* [ ] `steam://`
* [ ] `discord://`
* [ ] `magnet:`

### Files & System

* [ ] â€œOpen file locationâ€ works
* [ ] â€œReveal in file managerâ€ works
* [ ] GVFS enabled (MTP, SMB, trash)
* [ ] Polkit agent present

### Secrets

* [ ] Secret service available (KWallet)
* [ ] Git credential prompts work
* [ ] Browser â†” password manager works

---

## ğŸŸ¡ PHASE 9 â€” Gaming Stack

Once graphics + portals are solid.

### Gaming

* [ ] Steam
* [ ] Proton
* [ ] Wine
* [ ] GE-Proton
* [ ] ProtonUp-Qt
* [ ] MangoHud
* [ ] GameMode
* [ ] Gamescope

---

## ğŸŸ¡ PHASE 10 â€” Development Environment

Now safe to add heavier tooling.

### Development Tools

* [ ] Cursor IDE (`code-cursor-fhs`)
* [ ] Docker installed
* [ ] NVIDIA Container Toolkit (`--gpus all` support)
* [ ] GPG agent: `programs.gnupg.agent.enable = true`
* [ ] GPG SSH support: `programs.gnupg.agent.enableSSHSupport = true`
* [ ] `nix-index` enabled (for `nix-locate`)
* [ ] `comma` installed (run `$ , <cmd>` without installing)
* [ ] `direnv` enabled: `programs.direnv.enable = true`
  * [ ] Auto-loads `shell.nix` / `flake.nix` on `cd`

### Languages

* [ ] C# (.NET)
* [ ] Go
* [ ] Node.js
* [ ] Rust
* [ ] Python

---

## ğŸŸ¢ PHASE 11 â€” Power Management & Polishing (Last)

Do this last to avoid masking issues.

### Power

* [ ] Suspend works
* [ ] Hibernate works
* [ ] Lid close:
  * [ ] Suspend on battery
  * [ ] Ignore on external power
* [ ] Battery limits **not needed**

### Maintenance & Firmware

* [ ] Garbage collection: `nix.gc.automatic = true`
* [ ] GC frequency: `nix.gc.dates = "weekly"`
* [ ] GC options: `nix.gc.options = "--delete-older-than 14d"`
* [ ] Store optimisation: `nix.settings.auto-optimise-store = true`
  * Links identical files in `/nix/store` to save disk space
* [ ] Firmware updates: `services.fwupd.enable = true`
  * Enables BIOS/firmware updates for ASUS via LVFS
* [ ] Weekly Btrfs scrub (already in Phase 6)

---

## ğŸŸ¢ PHASE 12 â€” Cursor / FHS Verification

Final sanity checks.

* [ ] Cursor can call `xdg-open`
* [ ] "Open in browser" works
* [ ] Correct default browser used
* [ ] Wayland portals respected
* [ ] Cursor not run inside `steam-run`

---

## ğŸ”µ PHASE 13 â€” Visuals & UX (Post-Install)

* [ ] TODO: Install Nerd Fonts (FiraCode, JetBrainsMono)
* [ ] TODO: Setup Emoji support (Noto Color Emoji)
* [ ] TODO: Configure Shell Theme (Oh-My-Zsh / Starship)

---

## âŒ Explicitly Not Needed (Do NOT Spend Time On)

* [ ] Secure Boot
* [ ] Battery tuning tools
* [ ] nixos-hardware exact laptop profile
* [ ] Running desktop apps inside FHS shells
* [ ] Over-engineering Git / SSH setup

---

## ğŸ“Œ Final Mental Model

* Install **disk â†’ kernel â†’ GPU â†’ desktop â†’ glue â†’ apps**
* Hybrid GPU daily, dGPU-only when docked
* Snapper = rollback safety
* FHS fixes binaries
* **Portals + MIME fix app interaction**

---

## ğŸ“ Module Import Pattern

Each subdirectory has a `default.nix` that imports its siblings:

```nix
# nixos/hardware/default.nix
{ ... }: {
  imports = [
    ./nvidia.nix
    ./asus.nix
    ./audio.nix
  ];
}
```

The main `configuration.nix` then imports directories (Nix auto-loads `default.nix`):

```nix
# nixos/configuration.nix
{ ... }: {
  imports = [
    ./hardware-configuration.nix
    ./system
    ./hardware
    ./desktop
    ./programs
    ./services
  ];

  networking.hostName = "rog-strix";
  # ... user config, nix settings, etc.
}
```

This keeps the orchestrator clean and makes each concern fully isolated.